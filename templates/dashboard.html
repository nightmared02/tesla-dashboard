<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla Dashboard - EVO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .bg-tesla-red { background-color: #cc0000; }
        .bg-tesla-dark { background-color: #212121; }
        .bg-tesla-gray { background-color: #818181; }
        .bg-tesla-light { background-color: #f2f2f2; }
        .bg-tesla-white { background-color: #fafafa; }
        .text-tesla-red { color: #cc0000; }
        .text-tesla-dark { color: #212121; }
        .text-tesla-gray { color: #818181; }
        .border-tesla-red { border-color: #cc0000; }
        .border-tesla-dark { border-color: #212121; }
        .border-tesla-gray { border-color: #818181; }
        .hover\:bg-tesla-red:hover { background-color: #cc0000; }
        .hover\:bg-tesla-dark:hover { background-color: #212121; }
        .hover\:text-tesla-red:hover { color: #cc0000; }
        .focus\:ring-tesla-red:focus { --tw-ring-color: #cc0000; }
        .focus\:border-tesla-red:focus { border-color: #cc0000; }
    </style>
</head>
<body class="bg-tesla-white min-h-screen">
    <!-- Header -->
    <header class="bg-tesla-dark shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-white">Tesla Dashboard</h1>
                        <p class="text-tesla-gray text-sm">EVO - Real-time Vehicle Monitoring</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-300">Auto-refresh:</label>
                        <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 text-tesla-red bg-gray-700 border-gray-600 rounded focus:ring-tesla-red focus:ring-2">
                    </div>
                    <button id="refreshBtn" class="px-3 py-1 text-sm bg-tesla-red text-white rounded hover:bg-red-700 transition-colors">
                        Refresh Now
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Battery Level Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="battery">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Battery Level</p>
                        <p class="text-2xl font-bold text-gray-900" id="batteryLevel">--</p>
                        <p class="text-sm text-gray-500" id="batteryStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Bolt -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Battery Range Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="battery_range">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Battery Range</p>
                        <p class="text-2xl font-bold text-gray-900" id="batteryRange">--</p>
                        <p class="text-sm text-gray-500" id="rangeStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Map -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Temperature Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="temperature">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Temperature</p>
                        <p class="text-2xl font-bold text-gray-900" id="temperature">--</p>
                        <p class="text-sm text-gray-500" id="tempStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Thermometer -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Tire Pressure Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="tire_pressure">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Tire Pressure</p>
                        <p class="text-2xl font-bold text-gray-900" id="tirePressure">--</p>
                        <p class="text-sm text-gray-500" id="tireStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Gauge -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m0 0a7 7 0 100-14 7 7 0 000 14zm0 0v2m0-2a7 7 0 100-14 7 7 0 000 14z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Speed Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="speed">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Speed</p>
                        <p class="text-2xl font-bold text-gray-900" id="speed">--</p>
                        <p class="text-sm text-gray-500" id="speedStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Speedometer -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m0 0a7 7 0 100-14 7 7 0 000 14zm0 0v2m0-2a7 7 0 100-14 7 7 0 000 14z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Charging State Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="charging">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Charging</p>
                        <p class="text-2xl font-bold text-gray-900" id="chargingState">--</p>
                        <p class="text-sm text-gray-500" id="chargingStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Plug -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Climate Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="climate">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Climate</p>
                        <p class="text-2xl font-bold text-gray-900" id="climateState">--</p>
                        <p class="text-sm text-gray-500" id="climateStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Sun -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Odometer Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="odometer">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Odometer</p>
                        <p class="text-2xl font-bold text-gray-900" id="odometer">--</p>
                        <p class="text-sm text-gray-500" id="odoStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Speedometer -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m0 0a7 7 0 100-14 7 7 0 000 14zm0 0v2m0-2a7 7 0 100-14 7 7 0 000 14z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Vehicle State Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="vehicle_state">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Vehicle State</p>
                        <p class="text-2xl font-bold text-gray-900" id="vehicleState">--</p>
                        <p class="text-sm text-gray-500" id="vehicleStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Car -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Charging Details Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="charging_details">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Charging Details</p>
                        <p class="text-2xl font-bold text-gray-900" id="chargingDetails">--</p>
                        <p class="text-sm text-gray-500" id="chargingDetailsStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Clock -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Location Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="location">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Location</p>
                        <p class="text-2xl font-bold text-gray-900" id="location">--</p>
                        <p class="text-sm text-gray-500" id="locationStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Map Pin -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/></svg>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>

            <!-- Usage Statistics Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200 cursor-pointer hover:shadow-lg transition" data-widget="usage_stats">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Usage Statistics</p>
                        <p class="text-lg font-bold text-gray-900" id="usageStatsTitle">Latest Session Counts</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Chart Pie -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13h6a3 3 0 002.76-1.84l.64-1.28a3 3 0 00.64-1.28A3 3 0 0015 6H3m0 7h6a3 3 0 002.76-1.84l.64-1.28a3 3 0 00.64-1.28A3 3 0 0015 0H3m0 7h6a3 3 0 002.76-1.84l.64-1.28a3 3 0 00.64-1.28A3 3 0 0015 0H3"/></svg>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-600" id="driveCount">--</p>
                        <p class="text-xs text-gray-500">Drive Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-green-600" id="chargeCount">--</p>
                        <p class="text-xs text-gray-500">Charge Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-yellow-600" id="idleCount">--</p>
                        <p class="text-xs text-gray-500">Idle Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-600" id="sleepCount">--</p>
                        <p class="text-xs text-gray-500">Sleep Sessions</p>
                    </div>
                </div>
                <p id="lastUpdateAll" class="text-xs text-tesla-gray mt-3">Last updated: --</p>
            </div>
        </div>

        <!-- Usage Statistics Card -->
        <!-- Removed: Usage stats pie chart and session counts chart from homepage -->
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-tesla-red"></div>
            <span class="text-tesla-dark">Loading...</span>
        </div>
    </div>

    <script>
        // Remove dateRange and updateCharts logic from homepage
        // Remove flatpickr and updateCharts calls
        // Remove chart initialization for usageStatsChart
        // Remove getChartByType and related chart update logic for homepage
        // (All charts are now on subpages)
        // Only update usage stats from /api/data/latest in updateLatestData()
        // (No chart or period summary on homepage)
        // Remove all code that references dateRange, updateCharts, usageStatsChart, and getChartByType in dashboard.html JS

        // Chart.js configuration with Tesla colors
        Chart.defaults.color = '#818181';
        Chart.defaults.borderColor = '#f2f2f2';
        
        const teslaColors = {
            primary: '#cc0000',
            secondary: '#212121',
            gray: '#818181',
            light: '#f2f2f2',
            white: '#fafafa'
        };

        // Initialize charts
        let batteryChart, temperatureChart, tirePressureChart, chargingChart, usageStatsChart;
        let autoRefreshInterval, chartRefreshInterval;
        let dateRange = null;
        
        const DATA_REFRESH_INTERVAL = 60000; // 1 minute
        const CHART_REFRESH_INTERVAL = 60000; // 1 minute

        function updateLatestData() {
            console.log('Fetching latest data...');
            // Add cache-busting parameter to prevent browser caching
            const timestamp = new Date().getTime();
            const url = `/api/data/latest?t=${timestamp}`;
            console.log('Fetching from URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('API Response status:', response.status);
                    console.log('API Response headers:', response.headers);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    console.log('Data type:', typeof data);
                    console.log('Data keys:', Object.keys(data));
                    console.log('Data has battery_level:', data && data.battery_level !== undefined);
                    console.log('battery_level value:', data ? data.battery_level : 'no data');
                    
                    if (data && data.battery_level !== undefined) {
                        console.log('Updating widgets with data...');
                        // Update status cards
                        if (document.getElementById('batteryLevel')) document.getElementById('batteryLevel').textContent = (data.battery_level !== null && data.battery_level !== undefined) ? `${data.battery_level}%` : '--';
                        if (document.getElementById('batteryStatus')) document.getElementById('batteryStatus').textContent = data.charging_state || 'Not charging';
                        
                        if (document.getElementById('batteryRange')) document.getElementById('batteryRange').textContent = (data.est_battery_range_km !== null && data.est_battery_range_km !== undefined) ? `${data.est_battery_range_km.toFixed(0)} km` : '--';
                        if (document.getElementById('rangeStatus')) document.getElementById('rangeStatus').textContent = 'Estimated range';
                        
                        if (document.getElementById('temperature')) document.getElementById('temperature').textContent = (data.outside_temp_c !== null && data.outside_temp_c !== undefined) ? `${data.outside_temp_c.toFixed(1)}°C` : '--';
                        if (document.getElementById('tempStatus')) document.getElementById('tempStatus').textContent = `Outside: ${(data.outside_temp_c !== null && data.outside_temp_c !== undefined) ? data.outside_temp_c.toFixed(1) : '--'}°C | Inside: ${(data.inside_temp_c !== null && data.inside_temp_c !== undefined) ? data.inside_temp_c.toFixed(1) : '--'}°C`;
                        
                        if (document.getElementById('tirePressure')) document.getElementById('tirePressure').textContent = (data.tpms_front_left_bar !== null && data.tpms_front_left_bar !== undefined) ? `${data.tpms_front_left_bar.toFixed(1)} bar` : '--';
                        if (document.getElementById('tireStatus')) document.getElementById('tireStatus').textContent = `FL: ${(data.tpms_front_left_bar !== null && data.tpms_front_left_bar !== undefined) ? data.tpms_front_left_bar.toFixed(1) : '--'} | FR: ${(data.tpms_front_right_bar !== null && data.tpms_front_right_bar !== undefined) ? data.tpms_front_right_bar.toFixed(1) : '--'} | RL: ${(data.tpms_rear_left_bar !== null && data.tpms_rear_left_bar !== undefined) ? data.tpms_rear_left_bar.toFixed(1) : '--'} | RR: ${(data.tpms_rear_right_bar !== null && data.tpms_rear_right_bar !== undefined) ? data.tpms_rear_right_bar.toFixed(1) : '--'}`;
                        
                        if (document.getElementById('speed')) document.getElementById('speed').textContent = (data.speed_kmh !== null && data.speed_kmh !== undefined) ? `${data.speed_kmh.toFixed(0)} km/h` : '--';
                        if (document.getElementById('speedStatus')) document.getElementById('speedStatus').textContent = data.shift_state || 'Parked';
                        
                        if (document.getElementById('chargingState')) document.getElementById('chargingState').textContent = data.charging_state || 'Disconnected';
                        if (document.getElementById('chargingStatus')) document.getElementById('chargingStatus').textContent = (data.charge_rate !== null && data.charge_rate !== undefined) ? `${data.charge_rate.toFixed(1)} kW` : 'Not charging';
                        
                        if (document.getElementById('climateState')) document.getElementById('climateState').textContent = data.is_climate_on ? 'ON' : 'OFF';
                        if (document.getElementById('climateStatus')) document.getElementById('climateStatus').textContent = `Driver: ${(data.driver_temp_setting_c !== null && data.driver_temp_setting_c !== undefined) ? data.driver_temp_setting_c.toFixed(1) : '--'}°C | Passenger: ${(data.passenger_temp_setting_c !== null && data.passenger_temp_setting_c !== undefined) ? data.passenger_temp_setting_c.toFixed(1) : '--'}°C`;
                        
                        if (document.getElementById('odometer')) document.getElementById('odometer').textContent = (data.odometer_km !== null && data.odometer_km !== undefined) ? `${data.odometer_km.toFixed(1)} km` : '--';
                        if (document.getElementById('odoStatus')) document.getElementById('odoStatus').textContent = 'Total distance';
                        
                        // Vehicle State
                        const lockedStatus = data.locked ? 'Locked' : 'Unlocked';
                        const sentryStatus = data.sentry_mode ? 'Sentry ON' : 'Sentry OFF';
                        const valetStatus = data.valet_mode ? 'Valet ON' : 'Valet OFF';
                        if (document.getElementById('vehicleState')) document.getElementById('vehicleState').textContent = lockedStatus;
                        if (document.getElementById('vehicleStatus')) document.getElementById('vehicleStatus').textContent = `${sentryStatus} | ${valetStatus}`;
                        
                        // Charging Details
                        if (data.time_to_full_charge !== null && data.time_to_full_charge !== undefined && data.time_to_full_charge > 0) {
                            const hours = Math.floor(data.time_to_full_charge);
                            const minutes = Math.round((data.time_to_full_charge - hours) * 60);
                            if (document.getElementById('chargingDetails')) document.getElementById('chargingDetails').textContent = `${hours}h ${minutes}m`;
                        } else {
                            if (document.getElementById('chargingDetails')) document.getElementById('chargingDetails').textContent = '--';
                        }
                        const energyAdded = (data.charge_energy_added !== null && data.charge_energy_added !== undefined) ? `${data.charge_energy_added.toFixed(1)} kWh` : '--';
                        if (document.getElementById('chargingDetailsStatus')) document.getElementById('chargingDetailsStatus').textContent = `Added: ${energyAdded}`;
                        
                        // Location
                        if (data.latitude !== null && data.latitude !== undefined && data.longitude !== null && data.longitude !== undefined) {
                            if (document.getElementById('location')) document.getElementById('location').textContent = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
                        } else {
                            if (document.getElementById('location')) document.getElementById('location').textContent = '--';
                        }
                        const heading = (data.heading !== null && data.heading !== undefined) ? `${data.heading.toFixed(0)}°` : '--';
                        if (document.getElementById('locationStatus')) document.getElementById('locationStatus').textContent = `Heading: ${heading}`;
                        
                        // Update location string
                        if (document.getElementById('locationString')) document.getElementById('locationString').textContent = data.location || 'Location unavailable';
                        if (document.getElementById('lastUpdate')) document.getElementById('lastUpdate').textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
                        
                        // Usage Statistics
                        if (document.getElementById('driveCount')) document.getElementById('driveCount').textContent = (data.drive_number !== null && data.drive_number !== undefined) ? data.drive_number : '--';
                        if (document.getElementById('chargeCount')) document.getElementById('chargeCount').textContent = (data.charge_number !== null && data.charge_number !== undefined) ? data.charge_number : '--';
                        if (document.getElementById('idleCount')) document.getElementById('idleCount').textContent = (data.idle_number !== null && data.idle_number !== undefined) ? data.idle_number : '--';
                        if (document.getElementById('sleepCount')) document.getElementById('sleepCount').textContent = (data.sleep_number !== null && data.sleep_number !== undefined) ? data.sleep_number : '--';
                        
                        // After updating all widgets, set last updated on all cards
                        const lastUpdated = data.timestamp ? new Date(data.timestamp).toLocaleString() : '--';
                        document.querySelectorAll('[id="lastUpdateAll"]').forEach(el => { el.textContent = `Last updated: ${lastUpdated}`; });
                        
                        console.log('Widgets updated successfully');
                        console.log('Sample values updated:', {
                            battery_level: data.battery_level,
                            battery_range_km: data.est_battery_range_km,
                            outside_temp_c: data.outside_temp_c,
                            tpms_front_left_bar: data.tpms_front_left_bar,
                            speed_kmh: data.speed_kmh,
                            charging_state: data.charging_state,
                            is_climate_on: data.is_climate_on,
                            odometer_km: data.odometer_km,
                            locked: data.locked,
                            sentry_mode: data.sentry_mode,
                            valet_mode: data.valet_mode,
                            time_to_full_charge: data.time_to_full_charge,
                            charge_energy_added: data.charge_energy_added,
                            latitude: data.latitude,
                            longitude: data.longitude,
                            location: data.location,
                            drive_number: data.drive_number,
                            charge_number: data.charge_number,
                            idle_number: data.idle_number,
                            sleep_number: data.sleep_number
                        });
                    } else if (data.message) {
                        console.log('No data available message:', data.message);
                        // Handle no data available message
                        if (document.getElementById('batteryLevel')) document.getElementById('batteryLevel').textContent = '--';
                        if (document.getElementById('batteryStatus')) document.getElementById('batteryStatus').textContent = 'No data';
                        if (document.getElementById('batteryRange')) document.getElementById('batteryRange').textContent = '--';
                        if (document.getElementById('rangeStatus')) document.getElementById('rangeStatus').textContent = 'No data';
                        if (document.getElementById('temperature')) document.getElementById('temperature').textContent = '--';
                        if (document.getElementById('tempStatus')) document.getElementById('tempStatus').textContent = 'No data';
                        if (document.getElementById('tirePressure')) document.getElementById('tirePressure').textContent = '--';
                        if (document.getElementById('tireStatus')) document.getElementById('tireStatus').textContent = 'No data';
                        if (document.getElementById('speed')) document.getElementById('speed').textContent = '--';
                        if (document.getElementById('speedStatus')) document.getElementById('speedStatus').textContent = 'No data';
                        if (document.getElementById('chargingState')) document.getElementById('chargingState').textContent = '--';
                        if (document.getElementById('chargingStatus')) document.getElementById('chargingStatus').textContent = 'No data';
                        if (document.getElementById('climateState')) document.getElementById('climateState').textContent = '--';
                        if (document.getElementById('climateStatus')) document.getElementById('climateStatus').textContent = 'No data';
                        if (document.getElementById('odometer')) document.getElementById('odometer').textContent = '--';
                        if (document.getElementById('odoStatus')) document.getElementById('odoStatus').textContent = 'No data';
                        if (document.getElementById('vehicleState')) document.getElementById('vehicleState').textContent = '--';
                        if (document.getElementById('vehicleStatus')) document.getElementById('vehicleStatus').textContent = 'No data';
                        if (document.getElementById('chargingDetails')) document.getElementById('chargingDetails').textContent = '--';
                        if (document.getElementById('chargingDetailsStatus')) document.getElementById('chargingDetailsStatus').textContent = 'No data';
                        if (document.getElementById('location')) document.getElementById('location').textContent = '--';
                        if (document.getElementById('locationStatus')) document.getElementById('locationStatus').textContent = 'No data';
                        if (document.getElementById('driveCount')) document.getElementById('driveCount').textContent = '--';
                        if (document.getElementById('chargeCount')) document.getElementById('chargeCount').textContent = '--';
                        if (document.getElementById('idleCount')) document.getElementById('idleCount').textContent = '--';
                        if (document.getElementById('sleepCount')) document.getElementById('sleepCount').textContent = '--';
                    } else {
                        console.log('Unexpected data format:', data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching latest data:', error);
                    console.error('Error details:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    // Show error state
                    if (document.getElementById('batteryLevel')) document.getElementById('batteryLevel').textContent = 'Error';
                    if (document.getElementById('batteryStatus')) document.getElementById('batteryStatus').textContent = 'Connection failed';
                    if (document.getElementById('batteryRange')) document.getElementById('batteryRange').textContent = 'Error';
                    if (document.getElementById('rangeStatus')) document.getElementById('rangeStatus').textContent = 'Connection failed';
                    if (document.getElementById('temperature')) document.getElementById('temperature').textContent = 'Error';
                    if (document.getElementById('tempStatus')) document.getElementById('tempStatus').textContent = 'Connection failed';
                    if (document.getElementById('tirePressure')) document.getElementById('tirePressure').textContent = 'Error';
                    if (document.getElementById('tireStatus')) document.getElementById('tireStatus').textContent = 'Connection failed';
                    if (document.getElementById('speed')) document.getElementById('speed').textContent = 'Error';
                    if (document.getElementById('speedStatus')) document.getElementById('speedStatus').textContent = 'Connection failed';
                    if (document.getElementById('chargingState')) document.getElementById('chargingState').textContent = 'Error';
                    if (document.getElementById('chargingStatus')) document.getElementById('chargingStatus').textContent = 'Connection failed';
                    if (document.getElementById('climateState')) document.getElementById('climateState').textContent = 'Error';
                    if (document.getElementById('climateStatus')) document.getElementById('climateStatus').textContent = 'Connection failed';
                    if (document.getElementById('odometer')) document.getElementById('odometer').textContent = 'Error';
                    if (document.getElementById('odoStatus')) document.getElementById('odoStatus').textContent = 'Connection failed';
                    if (document.getElementById('vehicleState')) document.getElementById('vehicleState').textContent = 'Error';
                    if (document.getElementById('vehicleStatus')) document.getElementById('vehicleStatus').textContent = 'Connection failed';
                    if (document.getElementById('chargingDetails')) document.getElementById('chargingDetails').textContent = 'Error';
                    if (document.getElementById('chargingDetailsStatus')) document.getElementById('chargingDetailsStatus').textContent = 'Connection failed';
                    if (document.getElementById('location')) document.getElementById('location').textContent = 'Error';
                    if (document.getElementById('locationStatus')) document.getElementById('locationStatus').textContent = 'Connection failed';
                    if (document.getElementById('driveCount')) document.getElementById('driveCount').textContent = '--';
                    if (document.getElementById('chargeCount')) document.getElementById('chargeCount').textContent = '--';
                    if (document.getElementById('idleCount')) document.getElementById('idleCount').textContent = '--';
                    if (document.getElementById('sleepCount')) document.getElementById('sleepCount').textContent = '--';
                });
        }

        function startAutoRefresh() {
            // Update data every 30 seconds
            autoRefreshInterval = setInterval(() => {
                updateLatestData();
            }, DATA_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', function() {
            updateLatestData();
        });

        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateLatestData();
            startAutoRefresh();
        });

        // Make widgets clickable and redirect to detailed graph page
        document.querySelectorAll('[data-widget]').forEach(function(card) {
            card.addEventListener('click', function() {
                const widget = card.getAttribute('data-widget');
                window.location.href = `/widget/${widget}`;
            });
        });
    </script>
</body>
</html>