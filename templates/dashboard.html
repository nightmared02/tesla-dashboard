<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla Dashboard - EVO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .bg-tesla-red { background-color: #cc0000; }
        .bg-tesla-dark { background-color: #212121; }
        .bg-tesla-gray { background-color: #818181; }
        .bg-tesla-light { background-color: #f2f2f2; }
        .bg-tesla-white { background-color: #fafafa; }
        .text-tesla-red { color: #cc0000; }
        .text-tesla-dark { color: #212121; }
        .text-tesla-gray { color: #818181; }
        .border-tesla-red { border-color: #cc0000; }
        .border-tesla-dark { border-color: #212121; }
        .border-tesla-gray { border-color: #818181; }
        .hover\:bg-tesla-red:hover { background-color: #cc0000; }
        .hover\:bg-tesla-dark:hover { background-color: #212121; }
        .hover\:text-tesla-red:hover { color: #cc0000; }
        .focus\:ring-tesla-red:focus { --tw-ring-color: #cc0000; }
        .focus\:border-tesla-red:focus { border-color: #cc0000; }
    </style>
</head>
<body class="bg-tesla-white min-h-screen">
    <!-- Header -->
    <header class="bg-tesla-dark shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-white">Tesla Dashboard</h1>
                        <p class="text-tesla-gray text-sm">EVO - Real-time Vehicle Monitoring</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="ingestBtn" class="bg-tesla-red hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Fetch Latest Data
                    </button>
                    <div class="flex items-center space-x-2">
                        <span class="text-tesla-gray text-sm">Auto-refresh:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoRefreshToggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-tesla-gray peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-tesla-red rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tesla-red"></div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Battery Status -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-tesla-gray text-sm font-medium">Battery Level</p>
                        <p id="batteryLevel" class="text-3xl font-bold text-tesla-dark">--</p>
                        <p id="batteryStatus" class="text-sm text-tesla-gray">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Temperature -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-tesla-gray text-sm font-medium">Temperature</p>
                        <p id="temperature" class="text-3xl font-bold text-tesla-dark">--</p>
                        <p id="tempStatus" class="text-sm text-tesla-gray">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Tire Pressure -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-tesla-gray text-sm font-medium">Tire Pressure</p>
                        <p id="tirePressure" class="text-3xl font-bold text-tesla-dark">--</p>
                        <p id="tireStatus" class="text-sm text-tesla-gray">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Odometer -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-tesla-gray text-sm font-medium">Odometer</p>
                        <p id="odometer" class="text-3xl font-bold text-tesla-dark">--</p>
                        <p id="odoStatus" class="text-sm text-tesla-gray">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location and Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Location -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Vehicle Location</h3>
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-tesla-red rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p id="location" class="text-tesla-dark font-medium">Loading location...</p>
                        <p id="lastUpdate" class="text-sm text-tesla-gray">Last updated: --</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Controls</h3>
                <div class="space-y-3">
                    <button id="manualRefreshBtn" class="w-full bg-tesla-light hover:bg-tesla-gray text-tesla-dark px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Manual Refresh
                    </button>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-tesla-gray">Data refresh:</span>
                        <span id="refreshStatus" class="text-sm font-medium text-tesla-red">30s</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-tesla-gray">Chart refresh:</span>
                        <span id="chartStatus" class="text-sm font-medium text-tesla-red">60s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Date Range Picker -->
        <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6 mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-tesla-dark mb-2">Chart Date Range</h3>
                    <p class="text-sm text-tesla-gray">Select a date range to filter chart data</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <input type="text" id="dateRange" placeholder="Select date range..." class="px-4 py-2 border border-tesla-gray rounded-lg focus:ring-2 focus:ring-tesla-red focus:border-tesla-red outline-none">
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Battery Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Battery Level Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="batteryChart"></canvas>
                </div>
            </div>

            <!-- Temperature Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Temperature Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>

            <!-- Tire Pressure Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Tire Pressure Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="tirePressureChart"></canvas>
                </div>
            </div>

            <!-- Charging Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Charging Status Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="chargingChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-tesla-red"></div>
            <span class="text-tesla-dark">Loading...</span>
        </div>
    </div>

    <script>
        // Chart.js configuration with Tesla colors
        Chart.defaults.color = '#818181';
        Chart.defaults.borderColor = '#f2f2f2';
        
        const teslaColors = {
            primary: '#cc0000',
            secondary: '#212121',
            gray: '#818181',
            light: '#f2f2f2',
            white: '#fafafa'
        };

        // Initialize charts
        let batteryChart, temperatureChart, tirePressureChart, chargingChart;
        let autoRefreshInterval, chartRefreshInterval;
        let dateRange = null;

        // Initialize date picker
        flatpickr("#dateRange", {
            mode: "range",
            dateFormat: "Y-m-d",
            placeholder: "Select date range...",
            onChange: function(selectedDates) {
                if (selectedDates.length === 2) {
                    dateRange = {
                        start: selectedDates[0].toISOString().split('T')[0],
                        end: selectedDates[1].toISOString().split('T')[0]
                    };
                    updateCharts();
                }
            }
        });

        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: teslaColors.secondary,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: teslaColors.secondary,
                        titleColor: teslaColors.white,
                        bodyColor: teslaColors.white,
                        borderColor: teslaColors.red,
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: teslaColors.light
                        },
                        ticks: {
                            color: teslaColors.gray
                        }
                    },
                    y: {
                        grid: {
                            color: teslaColors.light
                        },
                        ticks: {
                            color: teslaColors.gray
                        }
                    }
                }
            };

            // Battery Chart
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            batteryChart = new Chart(batteryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Battery Level (%)',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Temperature Chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Tire Pressure Chart
            const tireCtx = document.getElementById('tirePressureChart').getContext('2d');
            tirePressureChart = new Chart(tireCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tire Pressure (bar)',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Charging Chart
            const chargingCtx = document.getElementById('chargingChart').getContext('2d');
            chargingChart = new Chart(chargingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Charging Status',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        function updateLatestData() {
            fetch('/api/data/latest')
                .then(response => response.json())
                .then(data => {
                    if (data && data.battery_level !== undefined) {
                        // Update status cards
                        document.getElementById('batteryLevel').textContent = `${data.battery_level}%`;
                        document.getElementById('batteryStatus').textContent = data.charging_state || 'Not charging';
                        
                        document.getElementById('temperature').textContent = `${data.outside_temp_c}°C`;
                        document.getElementById('tempStatus').textContent = 'Outside temperature';
                        
                        document.getElementById('tirePressure').textContent = `${data.tpms_front_left_bar.toFixed(1)} bar`;
                        document.getElementById('tireStatus').textContent = 'Front left tire';
                        
                        document.getElementById('odometer').textContent = `${data.odometer_km.toFixed(1)} km`;
                        document.getElementById('odoStatus').textContent = 'Total distance';
                        
                        // Update location
                        document.getElementById('location').textContent = data.location || 'Location unavailable';
                        document.getElementById('lastUpdate').textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
                    } else if (data.message) {
                        // Handle no data available message
                        document.getElementById('batteryLevel').textContent = '--';
                        document.getElementById('batteryStatus').textContent = 'No data';
                        document.getElementById('temperature').textContent = '--';
                        document.getElementById('tempStatus').textContent = 'No data';
                        document.getElementById('tirePressure').textContent = '--';
                        document.getElementById('tireStatus').textContent = 'No data';
                        document.getElementById('odometer').textContent = '--';
                        document.getElementById('odoStatus').textContent = 'No data';
                        document.getElementById('location').textContent = 'No data available';
                        document.getElementById('lastUpdate').textContent = 'No data available';
                    }
                })
                .catch(error => {
                    console.error('Error fetching latest data:', error);
                    // Show error state
                    document.getElementById('batteryLevel').textContent = 'Error';
                    document.getElementById('batteryStatus').textContent = 'Connection failed';
                    document.getElementById('temperature').textContent = 'Error';
                    document.getElementById('tempStatus').textContent = 'Connection failed';
                    document.getElementById('tirePressure').textContent = 'Error';
                    document.getElementById('tireStatus').textContent = 'Connection failed';
                    document.getElementById('odometer').textContent = 'Error';
                    document.getElementById('odoStatus').textContent = 'Connection failed';
                    document.getElementById('location').textContent = 'Connection error';
                    document.getElementById('lastUpdate').textContent = 'Connection failed';
                });
        }

        function updateCharts() {
            const params = new URLSearchParams();
            if (dateRange) {
                params.append('start_date', dateRange.start);
                params.append('end_date', dateRange.end);
            }

            // Update each chart
            ['battery', 'temperature', 'tire_pressure', 'charging'].forEach(chartType => {
                fetch(`/api/charts/${chartType}?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const chart = getChartByType(chartType);
                            if (chart) {
                                chart.data.labels = data.data.labels;
                                chart.data.datasets[0].data = data.data.values;
                                chart.update('none');
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error updating ${chartType} chart:`, error);
                    });
            });
        }

        function getChartByType(type) {
            switch(type) {
                case 'battery': return batteryChart;
                case 'temperature': return temperatureChart;
                case 'tire_pressure': return tirePressureChart;
                case 'charging': return chargingChart;
                default: return null;
            }
        }

        function startAutoRefresh() {
            // Update data every 30 seconds
            autoRefreshInterval = setInterval(() => {
                updateLatestData();
            }, 30000);

            // Update charts every 60 seconds
            chartRefreshInterval = setInterval(() => {
                updateCharts();
            }, 60000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (chartRefreshInterval) {
                clearInterval(chartRefreshInterval);
                chartRefreshInterval = null;
            }
        }

        // Event listeners
        document.getElementById('ingestBtn').addEventListener('click', function() {
            this.disabled = true;
            this.textContent = 'Fetching...';
            
            fetch('/api/ingest', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateLatestData();
                        updateCharts();
                    }
                })
                .catch(error => {
                    console.error('Error ingesting data:', error);
                })
                .finally(() => {
                    this.disabled = false;
                    this.textContent = 'Fetch Latest Data';
                });
        });

        document.getElementById('manualRefreshBtn').addEventListener('click', function() {
            updateLatestData();
            updateCharts();
        });

        document.getElementById('autoRefreshToggle').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
                document.getElementById('refreshStatus').textContent = '30s';
                document.getElementById('chartStatus').textContent = '60s';
            } else {
                stopAutoRefresh();
                document.getElementById('refreshStatus').textContent = 'Off';
                document.getElementById('chartStatus').textContent = 'Off';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateLatestData();
            updateCharts();
            startAutoRefresh();
        });
    </script>
</body>
</html> 