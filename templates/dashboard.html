<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla Dashboard - EVO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .bg-tesla-red { background-color: #cc0000; }
        .bg-tesla-dark { background-color: #212121; }
        .bg-tesla-gray { background-color: #818181; }
        .bg-tesla-light { background-color: #f2f2f2; }
        .bg-tesla-white { background-color: #fafafa; }
        .text-tesla-red { color: #cc0000; }
        .text-tesla-dark { color: #212121; }
        .text-tesla-gray { color: #818181; }
        .border-tesla-red { border-color: #cc0000; }
        .border-tesla-dark { border-color: #212121; }
        .border-tesla-gray { border-color: #818181; }
        .hover\:bg-tesla-red:hover { background-color: #cc0000; }
        .hover\:bg-tesla-dark:hover { background-color: #212121; }
        .hover\:text-tesla-red:hover { color: #cc0000; }
        .focus\:ring-tesla-red:focus { --tw-ring-color: #cc0000; }
        .focus\:border-tesla-red:focus { border-color: #cc0000; }
    </style>
</head>
<body class="bg-tesla-white min-h-screen">
    <!-- Header -->
    <header class="bg-tesla-dark shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-white">Tesla Dashboard</h1>
                        <p class="text-tesla-gray text-sm">EVO - Real-time Vehicle Monitoring</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-300">Auto-refresh:</label>
                        <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 text-tesla-red bg-gray-700 border-gray-600 rounded focus:ring-tesla-red focus:ring-2">
                    </div>
                    <button id="refreshBtn" class="px-3 py-1 text-sm bg-tesla-red text-white rounded hover:bg-red-700 transition-colors">
                        Refresh Now
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Battery Level Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Battery Level</p>
                        <p class="text-2xl font-bold text-gray-900" id="batteryLevel">--</p>
                        <p class="text-sm text-gray-500" id="batteryStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Bolt -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Battery Range Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Battery Range</p>
                        <p class="text-2xl font-bold text-gray-900" id="batteryRange">--</p>
                        <p class="text-sm text-gray-500" id="rangeStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Map -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"/></svg>
                    </div>
                </div>
            </div>

            <!-- Temperature Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Temperature</p>
                        <p class="text-2xl font-bold text-gray-900" id="temperature">--</p>
                        <p class="text-sm text-gray-500" id="tempStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Thermometer -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Tire Pressure Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Tire Pressure</p>
                        <p class="text-2xl font-bold text-gray-900" id="tirePressure">--</p>
                        <p class="text-sm text-gray-500" id="tireStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Gauge -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m0 0a7 7 0 100-14 7 7 0 000 14zm0 0v2m0-2a7 7 0 100-14 7 7 0 000 14z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Speed Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Speed</p>
                        <p class="text-2xl font-bold text-gray-900" id="speed">--</p>
                        <p class="text-sm text-gray-500" id="speedStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Speedometer -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m0 0a7 7 0 100-14 7 7 0 000 14zm0 0v2m0-2a7 7 0 100-14 7 7 0 000 14z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Charging State Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Charging</p>
                        <p class="text-2xl font-bold text-gray-900" id="chargingState">--</p>
                        <p class="text-sm text-gray-500" id="chargingStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Plug -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Climate Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Climate</p>
                        <p class="text-2xl font-bold text-gray-900" id="climateState">--</p>
                        <p class="text-sm text-gray-500" id="climateStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Sun -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Odometer Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Odometer</p>
                        <p class="text-2xl font-bold text-gray-900" id="odometer">--</p>
                        <p class="text-sm text-gray-500" id="odoStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Speedometer -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m0 0a7 7 0 100-14 7 7 0 000 14zm0 0v2m0-2a7 7 0 100-14 7 7 0 000 14z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Vehicle State Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Vehicle State</p>
                        <p class="text-2xl font-bold text-gray-900" id="vehicleState">--</p>
                        <p class="text-sm text-gray-500" id="vehicleStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Car -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"/></svg>
                    </div>
                </div>
            </div>

            <!-- Charging Details Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Charging Details</p>
                        <p class="text-2xl font-bold text-gray-900" id="chargingDetails">--</p>
                        <p class="text-sm text-gray-500" id="chargingDetailsStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Clock -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Location Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Location</p>
                        <p class="text-2xl font-bold text-gray-900" id="location">--</p>
                        <p class="text-sm text-gray-500" id="locationStatus">--</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Map Pin -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Usage Statistics Card -->
            <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Usage Statistics</p>
                        <p class="text-lg font-bold text-gray-900" id="usageStatsTitle">Period Summary</p>
                    </div>
                    <div class="w-12 h-12 bg-tesla-red rounded-full flex items-center justify-center">
                        <!-- Heroicons: Chart Pie -->
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13h6a3 3 0 002.76-1.84l.64-1.28a3 3 0 00.64-1.28A3 3 0 0015 6H3m0 7h6a3 3 0 002.76-1.84l.64-1.28a3 3 0 00.64-1.28A3 3 0 0015 0H3m0 7h6a3 3 0 002.76-1.84l.64-1.28a3 3 0 00.64-1.28A3 3 0 0015 0H3"/></svg>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-600" id="driveCount">--</p>
                        <p class="text-xs text-gray-500">Drive Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-green-600" id="chargeCount">--</p>
                        <p class="text-xs text-gray-500">Charge Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-yellow-600" id="idleCount">--</p>
                        <p class="text-xs text-gray-500">Idle Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-600" id="sleepCount">--</p>
                        <p class="text-xs text-gray-500">Sleep Sessions</p>
                    </div>
                </div>
                <div class="h-32">
                    <canvas id="usageStatsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Location and Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Location -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Vehicle Location</h3>
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-tesla-red rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p id="location" class="text-tesla-dark font-medium">Loading location...</p>
                        <p id="lastUpdate" class="text-sm text-tesla-gray">Last updated: --</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Controls</h3>
                <div class="space-y-3">
                    <button id="manualRefreshBtn" class="w-full bg-tesla-light hover:bg-tesla-gray text-tesla-dark px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Manual Refresh
                    </button>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-tesla-gray">Data refresh:</span>
                        <span id="refreshStatus" class="text-sm font-medium text-tesla-red">30s</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-tesla-gray">Chart refresh:</span>
                        <span id="chartStatus" class="text-sm font-medium text-tesla-red">60s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Date Range Picker -->
        <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6 mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-tesla-dark mb-2">Chart Date Range</h3>
                    <p class="text-sm text-tesla-gray">Select a date range to filter chart data</p>
                </div>
                <div class="mt-4 sm:mt-0">
                    <input type="text" id="dateRange" placeholder="Select date range..." class="px-4 py-2 border border-tesla-gray rounded-lg focus:ring-2 focus:ring-tesla-red focus:border-tesla-red outline-none">
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Battery Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Battery Level Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="batteryChart"></canvas>
                </div>
            </div>

            <!-- Temperature Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Temperature Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>

            <!-- Tire Pressure Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Tire Pressure Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="tirePressureChart"></canvas>
                </div>
            </div>

            <!-- Charging Chart -->
            <div class="bg-white rounded-xl shadow-lg border border-tesla-light p-6">
                <h3 class="text-lg font-semibold text-tesla-dark mb-4">Charging Status Over Time</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="chargingChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-tesla-red"></div>
            <span class="text-tesla-dark">Loading...</span>
        </div>
    </div>

    <script>
        // Chart.js configuration with Tesla colors
        Chart.defaults.color = '#818181';
        Chart.defaults.borderColor = '#f2f2f2';
        
        const teslaColors = {
            primary: '#cc0000',
            secondary: '#212121',
            gray: '#818181',
            light: '#f2f2f2',
            white: '#fafafa'
        };

        // Initialize charts
        let batteryChart, temperatureChart, tirePressureChart, chargingChart, usageStatsChart;
        let autoRefreshInterval, chartRefreshInterval;
        let dateRange = null;
        
        const DATA_REFRESH_INTERVAL = 60000; // 1 minute
        const CHART_REFRESH_INTERVAL = 60000; // 1 minute

        // Initialize date picker
        flatpickr("#dateRange", {
            mode: "range",
            dateFormat: "Y-m-d",
            placeholder: "Select date range...",
            onChange: function(selectedDates) {
                if (selectedDates.length === 2) {
                    dateRange = {
                        start: selectedDates[0].toISOString().split('T')[0],
                        end: selectedDates[1].toISOString().split('T')[0]
                    };
                    updateCharts();
                }
            }
        });

        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: teslaColors.secondary,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: teslaColors.secondary,
                        titleColor: teslaColors.white,
                        bodyColor: teslaColors.white,
                        borderColor: teslaColors.red,
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: teslaColors.light
                        },
                        ticks: {
                            color: teslaColors.gray
                        }
                    },
                    y: {
                        grid: {
                            color: teslaColors.light
                        },
                        ticks: {
                            color: teslaColors.gray
                        }
                    }
                }
            };

            // Battery Chart
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            batteryChart = new Chart(batteryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Battery Level (%)',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Temperature Chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Tire Pressure Chart
            const tireCtx = document.getElementById('tirePressureChart').getContext('2d');
            tirePressureChart = new Chart(tireCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tire Pressure (bar)',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Charging Chart
            const chargingCtx = document.getElementById('chargingChart').getContext('2d');
            chargingChart = new Chart(chargingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Charging Status',
                        data: [],
                        borderColor: teslaColors.primary,
                        backgroundColor: teslaColors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Usage Stats Chart
            const usageStatsCtx = document.getElementById('usageStatsChart').getContext('2d');
            usageStatsChart = new Chart(usageStatsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Drive', 'Charge', 'Idle', 'Sleep'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#6B7280'],
                        borderColor: ['#2563EB', '#059669', '#D97706', '#4B5563'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateLatestData() {
            fetch('/api/data/latest')
                .then(response => response.json())
                .then(data => {
                    if (data && data.battery_level !== undefined) {
                        // Update status cards
                        document.getElementById('batteryLevel').textContent = `${data.battery_level}%`;
                        document.getElementById('batteryStatus').textContent = data.charging_state || 'Not charging';
                        
                        document.getElementById('batteryRange').textContent = `${data.battery_range_km !== undefined ? data.battery_range_km.toFixed(0) : '--'} km`;
                        document.getElementById('rangeStatus').textContent = 'Estimated range';
                        
                        document.getElementById('temperature').textContent = `${data.outside_temp_c !== undefined ? data.outside_temp_c.toFixed(1) : '--'}°C`;
                        document.getElementById('tempStatus').textContent = `Outside: ${data.outside_temp_c !== undefined ? data.outside_temp_c.toFixed(1) : '--'}°C | Inside: ${data.inside_temp_c !== undefined ? data.inside_temp_c.toFixed(1) : '--'}°C`;
                        
                        document.getElementById('tirePressure').textContent = `${data.tpms_front_left_bar !== undefined ? data.tpms_front_left_bar.toFixed(1) : '--'} bar`;
                        document.getElementById('tireStatus').textContent = `FL: ${data.tpms_front_left_bar !== undefined ? data.tpms_front_left_bar.toFixed(1) : '--'} | FR: ${data.tpms_front_right_bar !== undefined ? data.tpms_front_right_bar.toFixed(1) : '--'} | RL: ${data.tpms_rear_left_bar !== undefined ? data.tpms_rear_left_bar.toFixed(1) : '--'} | RR: ${data.tpms_rear_right_bar !== undefined ? data.tpms_rear_right_bar.toFixed(1) : '--'}`;
                        
                        document.getElementById('speed').textContent = `${data.speed_kmh !== undefined ? data.speed_kmh.toFixed(0) : '--'} km/h`;
                        document.getElementById('speedStatus').textContent = data.shift_state || 'Parked';
                        
                        document.getElementById('chargingState').textContent = data.charging_state || 'Disconnected';
                        document.getElementById('chargingStatus').textContent = data.charge_rate !== undefined ? `${data.charge_rate.toFixed(1)} kW` : 'Not charging';
                        
                        document.getElementById('climateState').textContent = data.is_climate_on ? 'ON' : 'OFF';
                        document.getElementById('climateStatus').textContent = `Driver: ${data.driver_temp_setting_c !== undefined ? data.driver_temp_setting_c.toFixed(1) : '--'}°C | Passenger: ${data.passenger_temp_setting_c !== undefined ? data.passenger_temp_setting_c.toFixed(1) : '--'}°C`;
                        
                        document.getElementById('odometer').textContent = `${data.odometer_km.toFixed(1)} km`;
                        document.getElementById('odoStatus').textContent = 'Total distance';
                        
                        // Vehicle State
                        const lockedStatus = data.locked ? 'Locked' : 'Unlocked';
                        const sentryStatus = data.sentry_mode ? 'Sentry ON' : 'Sentry OFF';
                        const valetStatus = data.valet_mode ? 'Valet ON' : 'Valet OFF';
                        document.getElementById('vehicleState').textContent = lockedStatus;
                        document.getElementById('vehicleStatus').textContent = `${sentryStatus} | ${valetStatus}`;
                        
                        // Charging Details
                        if (data.time_to_full_charge !== undefined && data.time_to_full_charge > 0) {
                            const hours = Math.floor(data.time_to_full_charge);
                            const minutes = Math.round((data.time_to_full_charge - hours) * 60);
                            document.getElementById('chargingDetails').textContent = `${hours}h ${minutes}m`;
                        } else {
                            document.getElementById('chargingDetails').textContent = '--';
                        }
                        const energyAdded = data.charge_energy_added !== undefined ? `${data.charge_energy_added.toFixed(1)} kWh` : '--';
                        document.getElementById('chargingDetailsStatus').textContent = `Added: ${energyAdded}`;
                        
                        // Location
                        if (data.latitude !== undefined && data.longitude !== undefined) {
                            document.getElementById('location').textContent = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
                        } else {
                            document.getElementById('location').textContent = '--';
                        }
                        const heading = data.heading !== undefined ? `${data.heading.toFixed(0)}°` : '--';
                        document.getElementById('locationStatus').textContent = `Heading: ${heading}`;
                        
                        // Update location string
                        document.getElementById('locationString').textContent = data.location || 'Location unavailable';
                        document.getElementById('lastUpdate').textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
                    } else if (data.message) {
                        // Handle no data available message
                        document.getElementById('batteryLevel').textContent = '--';
                        document.getElementById('batteryStatus').textContent = 'No data';
                        document.getElementById('batteryRange').textContent = '--';
                        document.getElementById('rangeStatus').textContent = 'No data';
                        document.getElementById('temperature').textContent = '--';
                        document.getElementById('tempStatus').textContent = 'No data';
                        document.getElementById('tirePressure').textContent = '--';
                        document.getElementById('tireStatus').textContent = 'No data';
                        document.getElementById('speed').textContent = '--';
                        document.getElementById('speedStatus').textContent = 'No data';
                        document.getElementById('chargingState').textContent = '--';
                        document.getElementById('chargingStatus').textContent = 'No data';
                        document.getElementById('climateState').textContent = '--';
                        document.getElementById('climateStatus').textContent = 'No data';
                        document.getElementById('odometer').textContent = '--';
                        document.getElementById('odoStatus').textContent = 'No data';
                        document.getElementById('vehicleState').textContent = '--';
                        document.getElementById('vehicleStatus').textContent = 'No data';
                        document.getElementById('chargingDetails').textContent = '--';
                        document.getElementById('chargingDetailsStatus').textContent = 'No data';
                        document.getElementById('location').textContent = '--';
                        document.getElementById('locationStatus').textContent = 'No data';
                        document.getElementById('driveCount').textContent = '--';
                        document.getElementById('chargeCount').textContent = '--';
                        document.getElementById('idleCount').textContent = '--';
                        document.getElementById('sleepCount').textContent = '--';
                    }
                })
                .catch(error => {
                    console.error('Error fetching latest data:', error);
                    // Show error state
                    document.getElementById('batteryLevel').textContent = 'Error';
                    document.getElementById('batteryStatus').textContent = 'Connection failed';
                    document.getElementById('batteryRange').textContent = 'Error';
                    document.getElementById('rangeStatus').textContent = 'Connection failed';
                    document.getElementById('temperature').textContent = 'Error';
                    document.getElementById('tempStatus').textContent = 'Connection failed';
                    document.getElementById('tirePressure').textContent = 'Error';
                    document.getElementById('tireStatus').textContent = 'Connection failed';
                    document.getElementById('speed').textContent = 'Error';
                    document.getElementById('speedStatus').textContent = 'Connection failed';
                    document.getElementById('chargingState').textContent = 'Error';
                    document.getElementById('chargingStatus').textContent = 'Connection failed';
                    document.getElementById('climateState').textContent = 'Error';
                    document.getElementById('climateStatus').textContent = 'Connection failed';
                    document.getElementById('odometer').textContent = 'Error';
                    document.getElementById('odoStatus').textContent = 'Connection failed';
                    document.getElementById('vehicleState').textContent = 'Error';
                    document.getElementById('vehicleStatus').textContent = 'Connection failed';
                    document.getElementById('chargingDetails').textContent = 'Error';
                    document.getElementById('chargingDetailsStatus').textContent = 'Connection failed';
                    document.getElementById('location').textContent = 'Error';
                    document.getElementById('locationStatus').textContent = 'Connection failed';
                    document.getElementById('driveCount').textContent = '--';
                    document.getElementById('chargeCount').textContent = '--';
                    document.getElementById('idleCount').textContent = '--';
                    document.getElementById('sleepCount').textContent = '--';
                });
        }

        function updateCharts() {
            const params = new URLSearchParams();
            if (dateRange) {
                params.append('start_date', dateRange.start);
                params.append('end_date', dateRange.end);
            }

            // Update each chart
            ['battery', 'temperature', 'tire_pressure', 'charging', 'usage_stats'].forEach(chartType => {
                fetch(`/api/charts/${chartType}?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const chart = getChartByType(chartType);
                            if (chart) {
                                if (chartType === 'usage_stats') {
                                    // Handle usage stats chart (pie chart)
                                    chart.data.labels = data.data.labels;
                                    chart.data.datasets[0].data = data.data.datasets[0].data;
                                    chart.update('none');
                                    
                                    // Update the count displays
                                    if (data.data.totals) {
                                        document.getElementById('driveCount').textContent = data.data.totals.drive;
                                        document.getElementById('chargeCount').textContent = data.data.totals.charge;
                                        document.getElementById('idleCount').textContent = data.data.totals.idle;
                                        document.getElementById('sleepCount').textContent = data.data.totals.sleep;
                                    }
                                } else {
                                    // Handle line charts
                                    chart.data.labels = data.data.labels;
                                    chart.data.datasets[0].data = data.data.values;
                                    chart.update('none');
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error updating ${chartType} chart:`, error);
                    });
            });
        }

        function getChartByType(type) {
            switch(type) {
                case 'battery': return batteryChart;
                case 'temperature': return temperatureChart;
                case 'tire_pressure': return tirePressureChart;
                case 'charging': return chargingChart;
                case 'usage_stats': return usageStatsChart;
                default: return null;
            }
        }

        function startAutoRefresh() {
            // Update data every 30 seconds
            autoRefreshInterval = setInterval(() => {
                updateLatestData();
            }, DATA_REFRESH_INTERVAL);

            // Update charts every 60 seconds
            chartRefreshInterval = setInterval(() => {
                updateCharts();
            }, CHART_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (chartRefreshInterval) {
                clearInterval(chartRefreshInterval);
                chartRefreshInterval = null;
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', function() {
            updateLatestData();
            updateCharts();
        });

        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
                document.getElementById('refreshStatus').textContent = '30s';
                document.getElementById('chartStatus').textContent = '60s';
            } else {
                stopAutoRefresh();
                document.getElementById('refreshStatus').textContent = 'Off';
                document.getElementById('chartStatus').textContent = 'Off';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateLatestData();
            updateCharts();
            startAutoRefresh();
        });
    </script>
</body>
</html>